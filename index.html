<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rodriguez Alberghini | Negocios Inmobiliarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #dc2626; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .map-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            pointer-events: none;
        }
        .map-marker-pin {
            width: 30px;
            height: 30px;
            background: #dc2626;
            border: 4px solid #fff;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);
            position: relative;
        }
        .map-marker-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: rgba(220, 38, 38, 0.4);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }
        .map-marker-pulse-2 {
            animation-delay: 0.5s;
        }
        .map-marker-pulse-3 {
            animation-delay: 1s;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }
    </style>
</head>
<body class="bg-slate-50 antialiased">

<div id="app"></div>

<script>
const SUPABASE_URL = 'https://onrdidddfoomqlrowwmu.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ucmRpZGRkZm9vbXFscm93d211Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMDE1ODUsImV4cCI6MjA4Nzc3NzU4NX0.J2ITRXlxWcKqyZH8uUDCVieNUgFoC4YgrhqUD8lDcsg';

const { createClient } = window.supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

const CONFIG = {
    nombreEmpresa: "Rodriguez Alberghini",
    slogan: "Negocios Inmobiliarios",
    ciudad: "Balcarce, Buenos Aires",
    logoUrl: "https://images.wasi.co/empresas/b20221124082928320437.png",
    heroImage: "https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?auto=format&fit=crop&q=80&w=2000",
    aboutImage: "https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&q=80&w=800",
    barrios: ["Centro", "Cerro El Triunfo", "Villa Kelly", "Barrio Cerrado", "Avenidas", "Ruta 226"],
    tipos: ["Casa", "Departamento", "Terreno", "Local Comercial", "Duplex", "Quinta"]
};

let state = {
    vista: 'home',
    propiedades: [],
    propiedadSeleccionada: null,
    propiedadEditando: null,
    cargando: true,
    filtros: { tipo: '', operacion: '', dormitorios: '', barrio: '' }
};

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('admin') === 'true') {
    state.vista = 'admin';
} else if (urlParams.get('id')) {
    state.vista = 'detalle';
    state.propiedadSeleccionada = parseInt(urlParams.get('id'));
}

// WEBHOOK URL - Configurar aqu√≠ tu URL de webhook del CRM
const WEBHOOK_URL = ''; // Ejemplo: 'https://hooks.zapier.com/...' o 'https://tu-crm.com/webhook'

function generarCaptcha(propiedadId) {
    const num1 = Math.floor(Math.random() * 10) + 1;
    const num2 = Math.floor(Math.random() * 10) + 1;
    const elem1 = document.getElementById('captchaNum1_' + propiedadId);
    const elem2 = document.getElementById('captchaNum2_' + propiedadId);
    const elemEsperado = document.getElementById('captchaEsperado_' + propiedadId);
    if (elem1 && elem2 && elemEsperado) {
        elem1.textContent = num1;
        elem2.textContent = num2;
        elemEsperado.value = num1 + num2;
    }
}

async function enviarFormulario(event, propiedadId) {
    event.preventDefault();
    const form = document.getElementById('contactForm' + propiedadId);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Validar captcha
    if (parseInt(data.captcha) !== parseInt(data.captcha_esperado)) {
        alert('La verificacion es incorrecta. Por favor intenta de nuevo.');
        generarCaptcha(propiedadId);
        return;
    }
    
    // Preparar datos para enviar
    const payload = {
        nombre: data.nombre,
        apellido: data.apellido,
        email: data.email,
        celular: data.celular,
        interes: data.interes,
        propiedad: {
            id: data.propiedad_id,
            titulo: data.propiedad_titulo,
            tipo: data.propiedad_tipo,
            operacion: data.propiedad_operacion,
            barrio: data.propiedad_barrio,
            precio: data.propiedad_precio,
            url: data.propiedad_url
        },
        fecha: new Date().toISOString()
    };
    
    const btn = form.querySelector('button[type="submit"]');
    const btnTextoOriginal = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Enviando...';
    
    try {
        if (WEBHOOK_URL) {
            await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });
        }
        
        // Mostrar mensaje de √©xito
        form.innerHTML = '<div class="text-center py-8"><div class="text-5xl mb-4">‚úì</div><h4 class="text-xl font-bold text-gray-900 mb-2">¬°Consulta enviada!</h4><p class="text-gray-600">Nos pondremos en contacto contigo a la brevedad.</p></div>';
        
        console.log('Formulario enviado:', payload);
    } catch (error) {
        console.error('Error al enviar:', error);
        alert('Hubo un error al enviar. Por favor intenta de nuevo.');
        btn.disabled = false;
        btn.textContent = btnTextoOriginal;
    }
}

async function cargarPropiedades() {
    state.cargando = true;
    render();
    
    try {
        const { data, error } = await db.from('propiedades').select('*').eq('activa', true).order('destacada', { ascending: false }).order('created_at', { ascending: false });
        if (error) { console.error('Error:', error); state.propiedades = []; }
        else { state.propiedades = data || []; }
    } catch (e) { console.error('Error:', e); state.propiedades = []; }
    
    state.cargando = false;
    render();
}

async function cargarTodasPropiedades() {
    state.cargando = true;
    render();
    
    try {
        const { data, error } = await db.from('propiedades').select('*').order('created_at', { ascending: false });
        if (error) { console.error('Error:', error); state.propiedades = []; }
        else { state.propiedades = data || []; }
    } catch (e) { console.error('Error:', e); state.propiedades = []; }
    
    state.cargando = false;
    render();
}

async function guardarPropiedad(propiedad) {
    const caracteristicas = propiedad.caracteristicas_texto ? propiedad.caracteristicas_texto.split(',').map(c => c.trim()).filter(c => c) : [];
    const galeria = propiedad.galeria_texto ? propiedad.galeria_texto.split(',').map(g => g.trim()).filter(g => g) : [];
    
    const datos = {
        titulo: propiedad.titulo, tipo: propiedad.tipo, operacion: propiedad.operacion, barrio: propiedad.barrio,
        dormitorios: propiedad.dormitorios ? parseInt(propiedad.dormitorios) : null,
        banos: propiedad.banos ? parseInt(propiedad.banos) : null,
        superficie: parseInt(propiedad.superficie),
        precio: propiedad.precio ? parseInt(propiedad.precio) : null,
        moneda: propiedad.moneda || null, descripcion: propiedad.descripcion,
        caracteristicas: caracteristicas, imagen_principal: propiedad.imagen_principal, galeria: galeria,
        destacada: propiedad.destacada === 'true' || propiedad.destacada === true,
        activa: propiedad.activa === 'true' || propiedad.activa === true,
        latitud: propiedad.latitud ? parseFloat(propiedad.latitud) : null,
        longitud: propiedad.longitud ? parseFloat(propiedad.longitud) : null,
        video_portada: propiedad.video_portada || null
    };
    
    let result;
    if (propiedad.id) { result = await db.from('propiedades').update(datos).eq('id', propiedad.id); }
    else { result = await db.from('propiedades').insert([datos]); }
    
    if (result.error) { alert('Error al guardar: ' + result.error.message); return false; }
    return true;
}

async function eliminarPropiedad(id) {
    if (!confirm('Seguro que queres eliminar esta propiedad?')) return;
    const { error } = await db.from('propiedades').delete().eq('id', id);
    if (error) { alert('Error al eliminar: ' + error.message); }
    else { await cargarTodasPropiedades(); }
}

function formatPrecio(precio, moneda) {
    if (!precio) return "Consultar";
    const formatted = new Intl.NumberFormat('es-AR').format(precio);
    if (moneda === "USD") return "USD " + formatted;
    if (moneda === "ARS") return "$ " + formatted;
    return formatted;
}

function getVimeoId(url) {
    if (!url) return null;
    const match = url.match(/vimeo\.com\/(\d+)/);
    return match ? match[1] : null;
}

function isVimeoUrl(url) {
    return url && url.includes('vimeo.com');
}

function abrirLightbox(imgUrl) {
    const lightbox = document.createElement('div');
    lightbox.id = 'lightbox';
    lightbox.className = 'fixed inset-0 bg-black/95 z-[9999] flex items-center justify-center p-4 cursor-pointer';
    lightbox.onclick = function() { document.getElementById('lightbox').remove(); };
    lightbox.innerHTML = '<img src="' + imgUrl + '" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl"><button class="absolute top-6 right-6 text-white text-4xl font-light hover:text-gray-300">&times;</button>';
    document.body.appendChild(lightbox);
}

function filtrarPropiedades() {
    let resultado = [...state.propiedades];
    if (state.filtros.tipo) resultado = resultado.filter(p => p.tipo === state.filtros.tipo);
    if (state.filtros.operacion) resultado = resultado.filter(p => p.operacion === state.filtros.operacion);
    if (state.filtros.dormitorios) {
        if (state.filtros.dormitorios === "0") resultado = resultado.filter(p => p.dormitorios === 0);
        else if (state.filtros.dormitorios === "1") resultado = resultado.filter(p => p.dormitorios === 1);
        else if (state.filtros.dormitorios === "2") resultado = resultado.filter(p => p.dormitorios === 2);
        else if (state.filtros.dormitorios === "3+") resultado = resultado.filter(p => p.dormitorios !== null && p.dormitorios >= 3);
    }
    if (state.filtros.barrio) resultado = resultado.filter(p => p.barrio === state.filtros.barrio);
    return resultado;
}

function irA(vista, data) {
    state.vista = vista;
    if (vista === 'detalle') {
        state.propiedadSeleccionada = data;
        window.history.pushState({}, '', '?id=' + data);
    } else if (vista === 'home') {
        window.history.pushState({}, '', window.location.pathname);
    } else if (vista === 'admin') {
        window.history.pushState({}, '', '?admin=true');
    } else if (vista === 'admin-edit') {
        state.propiedadEditando = data;
    }
    window.scrollTo(0, 0);
    render();
}

function actualizarFiltro(campo, valor) {
    state.filtros[campo] = valor;
    render();
}

function renderLoader() {
    return '<div class="min-h-screen flex items-center justify-center"><div class="loader"></div></div>';
}

function renderPropertyCard(p) {
    const precioTexto = formatPrecio(p.precio, p.moneda);
    const dormsTexto = p.dormitorios === null ? '' : (p.dormitorios === 0 ? 'Mono' : p.dormitorios + ' Dorm');
    return '<div onclick="irA(\'detalle\', ' + p.id + ')" class="group bg-white rounded-3xl overflow-hidden border border-gray-200 hover:border-red-400 transition-all duration-300 shadow-sm hover:shadow-xl cursor-pointer"><div class="relative h-64 overflow-hidden"><div class="absolute top-4 left-4 z-20 ' + (p.operacion === 'Venta' ? 'bg-red-600' : 'bg-gray-800') + ' px-3 py-1 rounded-full text-xs font-bold text-white shadow-md">' + (p.operacion ? p.operacion.toUpperCase() : 'VENTA') + '</div>' + (p.destacada ? '<div class="absolute top-4 right-4 z-20 bg-amber-500 px-3 py-1 rounded-full text-xs font-bold text-white shadow-md">DESTACADA</div>' : '') + '<img src="' + (p.imagen_principal || 'https://via.placeholder.com/800x600?text=Sin+imagen') + '" alt="' + p.titulo + '" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"></div><div class="p-6"><span class="text-red-600 text-sm font-bold uppercase tracking-wider">' + (p.tipo || 'Propiedad') + '</span><h3 class="font-bold text-xl text-gray-900 mt-1 mb-2">' + p.titulo + '</h3><div class="flex items-center text-gray-500 text-sm mb-4 gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>' + (p.barrio || 'Balcarce') + '</div><div class="flex justify-between items-center border-t border-gray-100 pt-4"><div class="flex gap-4 text-gray-600 text-sm">' + (dormsTexto ? '<span>' + dormsTexto + '</span>' : '') + '<span>' + (p.superficie || 0) + ' m2</span></div><span class="font-bold text-red-600">' + precioTexto + '</span></div></div></div>';
}

function renderHome() {
    const propiedades = filtrarPropiedades();
    const tiposUnicos = [...new Set(state.propiedades.map(p => p.tipo).filter(t => t))];
    let tiposOptions = '<option value="">Todas</option>';
    tiposUnicos.forEach(t => { tiposOptions += '<option value="' + t + '" ' + (state.filtros.tipo === t ? 'selected' : '') + '>' + t + '</option>'; });
    let barriosOptions = '<option value="">Todos</option>';
    CONFIG.barrios.forEach(b => { barriosOptions += '<option value="' + b + '" ' + (state.filtros.barrio === b ? 'selected' : '') + '>' + b + '</option>'; });
    let propiedadesHTML = '';
    if (propiedades.length === 0) { propiedadesHTML = '<div class="text-center py-20 col-span-3"><p class="text-gray-500 text-xl">No se encontraron propiedades.</p><button onclick="state.filtros={tipo:\'\',operacion:\'\',dormitorios:\'\',barrio:\'\'};render();" class="mt-4 text-red-600 hover:underline font-medium">Limpiar filtros</button></div>'; }
    else { propiedades.forEach(p => { propiedadesHTML += renderPropertyCard(p); }); }
    
    return '<nav class="fixed w-full z-50 top-0 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100"><div class="container mx-auto px-6 py-4 flex justify-between items-center"><img src="' + CONFIG.logoUrl + '" alt="' + CONFIG.nombreEmpresa + '" class="h-12 object-contain"><div class="hidden md:flex gap-6 font-semibold text-gray-600"><a href="#buscador" class="hover:text-red-600 transition-colors">Buscador</a><a href="#proyectos" class="hover:text-red-600 transition-colors">Destacados</a><a href="#nosotros" class="hover:text-red-600 transition-colors">Quienes Somos</a></div><a href="#contacto" class="bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2.5 px-6 rounded-full transition-all shadow-lg">Contactenos</a></div></nav><header class="relative min-h-[90vh] flex flex-col justify-center items-center overflow-hidden pb-16 pt-20"><div class="absolute inset-0 z-0"><img src="' + CONFIG.heroImage + '" alt="Hero" class="absolute w-full h-full object-cover opacity-30"><div class="absolute inset-0 bg-gradient-to-b from-white/90 via-white/70 to-slate-50 z-10"></div></div><div class="relative z-20 container mx-auto px-6 text-center mt-10"><div class="max-w-4xl mx-auto"><span class="inline-block py-1 px-4 rounded-full bg-red-600/10 text-red-600 font-semibold text-sm tracking-widest uppercase mb-6">' + CONFIG.ciudad + '</span><h1 class="text-4xl md:text-6xl font-bold tracking-tight mb-6 text-gray-900 leading-tight">Encontra el lugar<br><span class="bg-gradient-to-r from-red-600 to-red-400 bg-clip-text text-transparent">ideal para tu familia</span></h1><p class="text-lg md:text-xl text-gray-600 font-light mt-6 max-w-2xl mx-auto mb-12">Acompanamos tus proyectos inmobiliarios con transparencia, experiencia y el mejor trato humano.</p></div><div id="buscador" class="max-w-5xl mx-auto bg-white/90 backdrop-blur-xl p-4 md:p-6 rounded-3xl border border-white shadow-xl"><div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><div class="text-left"><label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1">Tipologia</label><select onchange="actualizarFiltro(\'tipo\', this.value)" class="w-full bg-white border border-gray-200 text-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all font-medium cursor-pointer">' + tiposOptions + '</select></div><div class="text-left"><label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1">Operacion</label><select onchange="actualizarFiltro(\'operacion\', this.value)" class="w-full bg-white border border-gray-200 text-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all font-medium cursor-pointer"><option value="">Todas</option><option value="Venta" ' + (state.filtros.operacion === 'Venta' ? 'selected' : '') + '>Venta</option><option value="Alquiler" ' + (state.filtros.operacion === 'Alquiler' ? 'selected' : '') + '>Alquiler</option></select></div><div class="text-left"><label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1">Dormitorios</label><select onchange="actualizarFiltro(\'dormitorios\', this.value)" class="w-full bg-white border border-gray-200 text-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all font-medium cursor-pointer"><option value="">Indistinto</option><option value="0" ' + (state.filtros.dormitorios === '0' ? 'selected' : '') + '>Monoambiente</option><option value="1" ' + (state.filtros.dormitorios === '1' ? 'selected' : '') + '>1</option><option value="2" ' + (state.filtros.dormitorios === '2' ? 'selected' : '') + '>2</option><option value="3+" ' + (state.filtros.dormitorios === '3+' ? 'selected' : '') + '>3+</option></select></div><div class="text-left"><label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1">Barrio</label><select onchange="actualizarFiltro(\'barrio\', this.value)" class="w-full bg-white border border-gray-200 text-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all font-medium cursor-pointer">' + barriosOptions + '</select></div></div><p class="text-center text-gray-500 text-sm mt-4">' + propiedades.length + ' propiedades encontradas</p></div></div></header><section id="proyectos" class="py-20 relative z-20 bg-slate-50"><div class="container mx-auto px-6"><div class="text-center mb-16"><h2 class="text-3xl md:text-5xl font-bold mb-4 text-gray-900">Inmuebles Destacados</h2><div class="w-24 h-1 bg-red-600 mx-auto mb-6"></div><p class="text-gray-600 max-w-2xl mx-auto text-lg">Explora las mejores oportunidades en Balcarce y alrededores.</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">' + propiedadesHTML + '</div></div></section><section id="nosotros" class="py-24 relative bg-white border-y border-gray-200"><div class="container mx-auto px-6"><div class="bg-gray-50 rounded-3xl p-8 md:p-16 border border-gray-100 shadow-lg max-w-6xl mx-auto"><div class="flex flex-col md:flex-row items-center gap-12"><div class="w-full md:w-2/5"><img src="' + CONFIG.aboutImage + '" alt="Equipo" class="w-full h-auto rounded-2xl border border-gray-200 shadow-md"></div><div class="w-full md:w-3/5 text-left"><h2 class="text-3xl md:text-5xl font-bold mb-6 text-gray-900">Conocemos <span class="bg-gradient-to-r from-red-600 to-red-400 bg-clip-text text-transparent">nuestra ciudad.</span></h2><div class="w-16 h-1 bg-red-600 mb-8"></div><div class="space-y-6 text-gray-600 text-lg leading-relaxed"><p>Somos <strong>' + CONFIG.nombreEmpresa + '</strong>, una inmobiliaria con arraigo y vision de futuro en Balcarce.</p><p>Trabajamos cada dia para unir familias con sus hogares ideales, priorizando siempre la honestidad y la transparencia.</p><p><em class="text-gray-500">Nuestra mision es cuidar tu patrimonio como si fuera el nuestro.</em></p></div></div></div></div></div></section><section id="contacto" class="py-24 relative bg-white"><div class="container mx-auto px-6 max-w-4xl"><div class="text-center mb-16"><h2 class="text-4xl font-bold mb-4 text-gray-900">Dejanos tu consulta</h2><p class="text-gray-600 text-lg">Completa tus datos y te responderemos a la brevedad.</p></div><form class="bg-white p-8 md:p-12 rounded-3xl border border-gray-200 shadow-xl"><div class="grid md:grid-cols-2 gap-6 mb-8"><div><label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Nombre</label><input type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-5 py-4 focus:outline-none focus:border-red-500 transition-all"></div><div><label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Telefono</label><input type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-5 py-4 focus:outline-none focus:border-red-500 transition-all"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Mensaje</label><textarea rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-5 py-4 focus:outline-none focus:border-red-500 transition-all"></textarea></div></div><button type="button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold text-lg py-5 rounded-xl transition-all shadow-lg">Enviar Mensaje</button></form></div></section><footer class="py-10 text-center text-gray-500 text-sm border-t border-gray-200 bg-gray-50"><img src="' + CONFIG.logoUrl + '" alt="' + CONFIG.nombreEmpresa + '" class="h-8 mx-auto mb-4 opacity-50"><p>2026 ' + CONFIG.nombreEmpresa + ' | ' + CONFIG.slogan + '. ' + CONFIG.ciudad + '.</p></footer>';
}

function renderDetalle() {
    const p = state.propiedades.find(prop => prop.id === state.propiedadSeleccionada);
    if (!p) return '<div class="p-8 text-center">Propiedad no encontrada</div>';
    const precioTexto = formatPrecio(p.precio, p.moneda);
    const caracteristicas = p.caracteristicas || [];
    const galeria = p.galeria || [];
    let caracteristicasHTML = '';
    caracteristicas.forEach(c => { caracteristicasHTML += '<div class="flex items-center gap-2 text-gray-700"><span class="text-red-500">‚úì</span> ' + c + '</div>'; });
    let galeriaHTML = '';
    galeria.forEach(item => { 
        if (isVimeoUrl(item)) {
            galeriaHTML += '<div class="shrink-0 w-[350px] h-[220px] rounded-xl border border-gray-200 overflow-hidden bg-black"><iframe src="https://player.vimeo.com/video/' + getVimeoId(item) + '?title=0&byline=0&portrait=0" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>';
        } else {
            galeriaHTML += '<img src="' + item + '" alt="Foto" class="shrink-0 w-[300px] h-[200px] object-cover rounded-xl border border-gray-200 cursor-pointer hover:opacity-90 transition-opacity" onclick="abrirLightbox(\'' + item + '\')">';
        }
    });
    
    return '<div class="fixed top-0 w-full z-50 px-6 py-4 bg-white/95 backdrop-blur-md border-b border-gray-200 flex justify-between items-center shadow-sm"><img src="' + CONFIG.logoUrl + '" alt="Logo" class="h-8 object-contain cursor-pointer" onclick="irA(\'home\')"><button onclick="irA(\'home\')" class="text-red-600 border border-red-500/20 bg-red-500/5 px-5 py-2 rounded-full hover:bg-red-600 hover:text-white transition-colors flex items-center gap-2 font-bold text-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Volver</button></div><div class="relative w-full h-[70vh] min-h-[500px] mb-12 mt-16 bg-gray-900 overflow-hidden">' + (p.video_portada && getVimeoId(p.video_portada) ? '<div class="absolute inset-0 w-full h-full overflow-hidden"><iframe src="https://player.vimeo.com/video/' + getVimeoId(p.video_portada) + '?autoplay=1&muted=1&loop=1&background=1&quality=1080p" class="absolute top-1/2 left-1/2 min-w-[100vw] min-h-[100vh] w-auto h-auto" style="transform: translate(-50%, -50%) scale(1.5);" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe></div>' : '<img src="' + (p.imagen_principal || 'https://via.placeholder.com/1200x800') + '" alt="' + p.titulo + '" class="absolute inset-0 w-full h-full object-cover">') + '<div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-black/20"></div><div class="absolute bottom-0 left-0 w-full"><div class="container mx-auto px-6 pb-12"><div class="' + (p.operacion === 'Venta' ? 'bg-red-600' : 'bg-gray-800') + ' px-4 py-1.5 rounded-full text-sm font-bold text-white inline-flex items-center mb-4 shadow-lg">EN ' + (p.operacion || 'VENTA').toUpperCase() + '</div><h1 class="text-4xl md:text-6xl font-bold text-white mb-2 drop-shadow-lg">' + p.titulo + '</h1><p class="text-lg text-gray-200 flex items-center gap-2"><svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>' + (p.barrio || 'Balcarce') + '</p></div></div></div><div class="container mx-auto px-6 max-w-6xl mb-24"><div class="grid lg:grid-cols-3 gap-12"><div class="lg:col-span-2 space-y-8">' + (p.latitud && p.longitud ? '<div class="bg-white rounded-3xl border border-gray-200 shadow-sm overflow-hidden"><h3 class="text-2xl font-bold text-gray-900 p-8 pb-4 border-b border-gray-100">Ubicacion</h3><div class="relative w-full h-[400px]"><iframe src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d800!2d' + p.longitud + '!3d' + p.latitud + '!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e1!3m2!1ses!2sar!4v1700000000000!5m2!1ses!2sar" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe><div class="map-marker"><div class="map-marker-pulse"></div><div class="map-marker-pulse map-marker-pulse-2"></div><div class="map-marker-pulse map-marker-pulse-3"></div><div class="map-marker-pin"></div></div></div><a href="https://www.google.com/maps?q=' + p.latitud + ',' + p.longitud + '" target="_blank" class="block text-center py-4 text-red-600 hover:text-red-700 font-medium border-t border-gray-100">Abrir en Google Maps ‚Üí</a></div>' : '') + '<div class="bg-white p-8 rounded-3xl border border-gray-200 shadow-sm"><h3 class="text-2xl font-bold text-gray-900 mb-6 border-b border-gray-100 pb-4">Descripcion</h3><p class="text-gray-600 text-lg leading-relaxed">' + (p.descripcion || 'Sin descripcion disponible.') + '</p></div>' + (caracteristicas.length > 0 ? '<div class="bg-white p-8 rounded-3xl border border-gray-200 shadow-sm"><h3 class="text-2xl font-bold text-gray-900 mb-6 border-b border-gray-100 pb-4">Caracteristicas</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">' + caracteristicasHTML + '</div></div>' : '') + (galeria.length > 0 ? '<div><h3 class="text-2xl font-bold text-gray-900 mb-6">Galeria de fotos y videos</h3><div class="flex overflow-x-auto gap-4 pb-4 hide-scrollbar">' + galeriaHTML + '</div></div>' : '') + '</div><div class="lg:col-span-1"><div class="bg-gray-50 p-8 rounded-3xl border border-gray-200 sticky top-24 shadow-sm"><h3 class="text-xl font-bold text-gray-900 mb-6">Resumen</h3><ul class="space-y-4 mb-8 text-gray-600"><li class="flex justify-between border-b border-gray-200 pb-2"><span>Operacion</span><strong class="text-gray-900">' + (p.operacion || 'Venta') + '</strong></li><li class="flex justify-between border-b border-gray-200 pb-2"><span>Precio</span><strong class="text-red-600 font-bold">' + precioTexto + '</strong></li>' + (p.dormitorios !== null ? '<li class="flex justify-between border-b border-gray-200 pb-2"><span>Dormitorios</span><strong class="text-gray-900">' + (p.dormitorios === 0 ? 'Monoambiente' : p.dormitorios) + '</strong></li>' : '') + (p.banos ? '<li class="flex justify-between border-b border-gray-200 pb-2"><span>Banos</span><strong class="text-gray-900">' + p.banos + '</strong></li>' : '') + '<li class="flex justify-between border-b border-gray-200 pb-2"><span>Superficie</span><strong class="text-gray-900">' + (p.superficie || 0) + ' m2</strong></li><li class="flex justify-between border-b border-gray-200 pb-2"><span>Tipo</span><strong class="text-gray-900">' + (p.tipo || 'Propiedad') + '</strong></li></ul><button onclick="document.getElementById(\'formPropiedad\'+' + p.id + ').scrollIntoView({behavior:\'smooth\'});" class="w-full bg-red-600 text-white hover:bg-red-700 font-bold py-4 rounded-xl transition-colors text-lg shadow-md">Consultar por esta propiedad</button></div></div></div></div><section id="formPropiedad' + p.id + '" class="py-16 bg-gray-50"><div class="container mx-auto px-6 max-w-2xl"><div class="bg-white p-8 rounded-3xl border border-gray-200 shadow-xl"><h3 class="text-2xl font-bold text-gray-900 mb-2 text-center">Consultar por esta propiedad</h3><p class="text-gray-500 text-center mb-8">' + p.titulo + ' - ' + (p.barrio || 'Balcarce') + '</p><form id="contactForm' + p.id + '" onsubmit="enviarFormulario(event, ' + p.id + ')"><input type="hidden" name="propiedad_id" value="' + p.id + '"><input type="hidden" name="propiedad_titulo" value="' + p.titulo + '"><input type="hidden" name="propiedad_tipo" value="' + (p.tipo || '') + '"><input type="hidden" name="propiedad_operacion" value="' + (p.operacion || '') + '"><input type="hidden" name="propiedad_barrio" value="' + (p.barrio || '') + '"><input type="hidden" name="propiedad_precio" value="' + precioTexto + '"><input type="hidden" name="propiedad_url" value="' + window.location.origin + window.location.pathname + '?id=' + p.id + '"><div class="grid md:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label><input type="text" name="nombre" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Apellido *</label><input type="text" name="apellido" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all"></div></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Email *</label><input type="email" name="email" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all"></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Celular *</label><input type="tel" name="celular" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all" placeholder="+54 9 ..."></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Interes *</label><select name="interes" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all"><option value="">Selecciona una opcion</option><option value="comprar">Estoy interesado en comprar</option><option value="viendo">Solo estoy viendo</option><option value="info">Solo quiero mas informacion</option></select></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Verificacion: ¬øCuanto es <span id="captchaNum1_' + p.id + '"></span> + <span id="captchaNum2_' + p.id + '"></span>? *</label><input type="number" name="captcha" id="captchaInput_' + p.id + '" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all" placeholder="Resultado"><input type="hidden" name="captcha_esperado" id="captchaEsperado_' + p.id + '"></div><button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg">Enviar consulta</button><p class="text-xs text-gray-400 text-center mt-4">Al enviar aceptas que te contactemos sobre esta propiedad.</p></form></div></div></section>';
}

function renderAdmin() {
    let filasHTML = '';
    state.propiedades.forEach(p => {
        filasHTML += '<tr class="hover:bg-gray-50"><td class="px-6 py-4"><div class="flex items-center gap-3"><img src="' + (p.imagen_principal || 'https://via.placeholder.com/60') + '" class="w-12 h-12 rounded-lg object-cover"><div><div class="font-medium text-gray-900">' + p.titulo + '</div><div class="text-sm text-gray-500">' + p.barrio + '</div></div></div></td><td class="px-6 py-4 text-gray-600">' + (p.tipo || '-') + '</td><td class="px-6 py-4"><span class="' + (p.operacion === 'Venta' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700') + ' px-2 py-1 rounded-full text-xs font-medium">' + (p.operacion || 'Venta') + '</span></td><td class="px-6 py-4 text-gray-900 font-medium">' + formatPrecio(p.precio, p.moneda) + '</td><td class="px-6 py-4"><span class="' + (p.activa ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600') + ' px-2 py-1 rounded-full text-xs font-medium">' + (p.activa ? 'Activa' : 'Inactiva') + '</span>' + (p.destacada ? '<span class="ml-1 bg-amber-100 text-amber-700 px-2 py-1 rounded-full text-xs font-medium">‚òÖ</span>' : '') + '</td><td class="px-6 py-4 text-right"><button onclick="irA(\'admin-edit\',' + p.id + ')" class="text-blue-600 hover:text-blue-800 font-medium mr-3">Editar</button><button onclick="eliminarPropiedad(' + p.id + ')" class="text-red-600 hover:text-red-800 font-medium">Eliminar</button></td></tr>';
    });
    return '<div class="min-h-screen bg-gray-100"><div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4"><div class="max-w-7xl mx-auto flex justify-between items-center"><div class="flex items-center gap-4"><img src="' + CONFIG.logoUrl + '" alt="Logo" class="h-10"><span class="text-xl font-bold text-gray-800">Panel Admin</span></div><div class="flex gap-3"><a href="?" class="text-gray-600 hover:text-gray-800 font-medium">Ver sitio</a><button onclick="irA(\'admin-edit\',null)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">+ Nueva Propiedad</button></div></div></div><div class="max-w-7xl mx-auto p-6"><h1 class="text-2xl font-bold text-gray-900 mb-6">Propiedades (' + state.propiedades.length + ')</h1><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><table class="w-full"><thead class="bg-gray-50 border-b border-gray-200"><tr><th class="text-left px-6 py-4 text-xs font-bold text-gray-500 uppercase">Propiedad</th><th class="text-left px-6 py-4 text-xs font-bold text-gray-500 uppercase">Tipo</th><th class="text-left px-6 py-4 text-xs font-bold text-gray-500 uppercase">Operacion</th><th class="text-left px-6 py-4 text-xs font-bold text-gray-500 uppercase">Precio</th><th class="text-left px-6 py-4 text-xs font-bold text-gray-500 uppercase">Estado</th><th class="text-right px-6 py-4 text-xs font-bold text-gray-500 uppercase">Acciones</th></tr></thead><tbody class="divide-y divide-gray-200">' + filasHTML + '</tbody></table>' + (state.propiedades.length === 0 ? '<div class="p-12 text-center text-gray-500">No hay propiedades cargadas</div>' : '') + '</div></div></div>';
}

function renderAdminEdit() {
    const p = state.propiedadEditando ? state.propiedades.find(prop => prop.id === state.propiedadEditando) : null;
    const isNew = !p;
    let tiposOptions = '';
    CONFIG.tipos.forEach(t => { tiposOptions += '<option value="' + t + '" ' + (p && p.tipo === t ? 'selected' : '') + '>' + t + '</option>'; });
    let barriosOptions = '';
    CONFIG.barrios.forEach(b => { barriosOptions += '<option value="' + b + '" ' + (p && p.barrio === b ? 'selected' : '') + '>' + b + '</option>'; });
    
    return '<div class="min-h-screen bg-gray-100"><div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4"><div class="max-w-4xl mx-auto flex justify-between items-center"><div class="flex items-center gap-4"><button onclick="irA(\'admin\')" class="text-gray-600 hover:text-gray-800"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg></button><span class="text-xl font-bold text-gray-800">' + (isNew ? 'Nueva Propiedad' : 'Editar Propiedad') + '</span></div></div></div><div class="max-w-4xl mx-auto p-6"><form id="formPropiedad" class="bg-white rounded-xl shadow-sm border border-gray-200 p-8"><input type="hidden" name="id" value="' + (p ? p.id : '') + '"><div class="grid md:grid-cols-2 gap-6 mb-6"><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Titulo *</label><input type="text" name="titulo" value="' + (p ? p.titulo : '') + '" required class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label><select name="tipo" required class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500">' + tiposOptions + '</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Operacion *</label><select name="operacion" required class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500"><option value="Venta" ' + (p && p.operacion === 'Venta' ? 'selected' : '') + '>Venta</option><option value="Alquiler" ' + (p && p.operacion === 'Alquiler' ? 'selected' : '') + '>Alquiler</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Barrio *</label><select name="barrio" required class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500">' + barriosOptions + '</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Superficie m2 *</label><input type="number" name="superficie" value="' + (p ? p.superficie : '') + '" required class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Dormitorios</label><input type="number" name="dormitorios" value="' + (p && p.dormitorios !== null ? p.dormitorios : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500" placeholder="Dejar vacio para terrenos"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Banos</label><input type="number" name="banos" value="' + (p && p.banos !== null ? p.banos : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Precio</label><input type="number" name="precio" value="' + (p && p.precio !== null ? p.precio : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500" placeholder="Dejar vacio para Consultar"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Moneda</label><select name="moneda" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500"><option value="">Sin precio</option><option value="USD" ' + (p && p.moneda === 'USD' ? 'selected' : '') + '>USD</option><option value="ARS" ' + (p && p.moneda === 'ARS' ? 'selected' : '') + '>ARS</option></select></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Descripcion</label><textarea name="descripcion" rows="4" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500">' + (p ? p.descripcion : '') + '</textarea></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Caracteristicas (separadas por coma)</label><input type="text" name="caracteristicas_texto" value="' + (p && p.caracteristicas ? p.caracteristicas.join(', ') : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500" placeholder="Pileta, Quincho, Cochera"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">URL Imagen Principal</label><input type="url" name="imagen_principal" value="' + (p ? p.imagen_principal : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500" placeholder="https://..."></div><div class="md:col-span-2 p-4 bg-purple-50 rounded-lg border border-purple-200"><p class="text-sm text-purple-800 mb-3"><strong>üé¨ Video de portada (Vimeo):</strong> Si agregas un video, se mostrara como fondo en lugar de la imagen principal. El video se reproduce en loop sin sonido.</p><input type="url" name="video_portada" value="' + (p ? (p.video_portada || '') : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500" placeholder="https://vimeo.com/123456789"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">URLs Galeria - imagenes o videos de Vimeo (separadas por coma)</label><input type="text" name="galeria_texto" value="' + (p && p.galeria ? p.galeria.join(', ') : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500" placeholder="https://imagen.jpg, https://vimeo.com/123456, https://imagen2.jpg"></div><div class="md:col-span-2 p-4 bg-blue-50 rounded-lg border border-blue-200"><p class="text-sm text-blue-800 mb-3"><strong>üìç Ubicacion en mapa:</strong> Para obtener las coordenadas, busca la direccion en Google Maps, haz clic derecho en el punto exacto y copia las coordenadas que aparecen.</p><div class="grid md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Latitud</label><input type="text" name="latitud" value="' + (p && p.latitud ? p.latitud : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500" placeholder="Ej: -37.8456"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Longitud</label><input type="text" name="longitud" value="' + (p && p.longitud ? p.longitud : '') + '" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500" placeholder="Ej: -58.2549"></div></div></div><div><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="destacada" value="true" ' + (p && p.destacada ? 'checked' : '') + ' class="w-5 h-5 rounded border-gray-300 text-red-600 focus:ring-red-500"><span class="text-sm font-medium text-gray-700">Propiedad destacada</span></label></div><div><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="activa" value="true" ' + (p === null || p.activa !== false ? 'checked' : '') + ' class="w-5 h-5 rounded border-gray-300 text-red-600 focus:ring-red-500"><span class="text-sm font-medium text-gray-700">Propiedad activa</span></label></div></div><div class="flex gap-4 pt-6 border-t border-gray-200"><button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Guardar Propiedad</button><button type="button" onclick="irA(\'admin\')" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Cancelar</button></div></form></div></div>';
}

function render() {
    const app = document.getElementById('app');
    if (state.cargando) { app.innerHTML = renderLoader(); return; }
    switch (state.vista) {
        case 'detalle': 
            app.innerHTML = renderDetalle(); 
            setTimeout(function() { generarCaptcha(state.propiedadSeleccionada); }, 100);
            break;
        case 'admin': app.innerHTML = renderAdmin(); break;
        case 'admin-edit': app.innerHTML = renderAdminEdit(); setTimeout(setupForm, 0); break;
        default: app.innerHTML = renderHome();
    }
}

function setupForm() {
    const form = document.getElementById('formPropiedad');
    if (form) {
        form.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.destacada = form.querySelector('[name="destacada"]').checked;
            data.activa = form.querySelector('[name="activa"]').checked;
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            const success = await guardarPropiedad(data);
            if (success) { await cargarTodasPropiedades(); irA('admin'); }
            else { btn.disabled = false; btn.textContent = 'Guardar Propiedad'; }
        };
    }
}

async function init() {
    // Listener para bot√≥n atr√°s/adelante del navegador
    window.addEventListener('popstate', function() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('admin') === 'true') {
            state.vista = 'admin';
        } else if (params.get('id')) {
            state.vista = 'detalle';
            state.propiedadSeleccionada = parseInt(params.get('id'));
        } else {
            state.vista = 'home';
            state.propiedadSeleccionada = null;
        }
        render();
    });
    
    if (state.vista === 'admin' || state.vista === 'admin-edit') { await cargarTodasPropiedades(); }
    else { await cargarPropiedades(); }
}

init();
</script>
</body>
</html>
